(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
// Generated by CoffeeScript 2.3.2
(function() {
  var Config, GLOBALX, GLOBALY, Moon, SCALE, current_time, draw_grid, helpText, init, moonText, moons, pos_to_percent, redraw, svgDoc, timeText;

  current_time = 0;

  SCALE = 5e7;

  GLOBALX = 0;

  GLOBALY = 0;

  Moon = require("./moon.js");

  Config = require("./config.js");

  moons = Moon.parse_moons();

  pos_to_percent = function(x) {
    var percent;
    // Get coord as percentage of scale
    percent = ((x / SCALE) + 1) * 50;
    return percent;
  };

  draw_grid = function(svgDoc) {
    var i, j, results, x, y;
    // Draw grid
    svgDoc.selectAll("line").remove();
    svgDoc.append("line").attr("class", "grid-line-center").attr("x1", "0%").attr("x2", "100%").attr("y1", `${50 + GLOBALY}%`).attr("y2", `${50 + GLOBALY}%`);
    svgDoc.append("line").attr("class", "grid-line-center").attr("x1", `${50 + GLOBALX}%`).attr("x2", `${50 + GLOBALX}%`).attr("y1", "0%").attr("y2", "100%");
    for (y = i = 0; i < 20; y = ++i) {
      svgDoc.append("line").attr("class", "grid-line").attr("x1", "0%").attr("x2", "100%").attr("y1", y * 5 + "%").attr("y2", y * 5 + "%");
    }
    results = [];
    for (x = j = 0; j < 20; x = ++j) {
      results.push(svgDoc.append("line").attr("class", "grid-line").attr("x1", x * 5 + "%").attr("x2", x * 5 + "%").attr("y1", "0%").attr("y2", "100%"));
    }
    return results;
  };

  // Initialize SVG
  svgDoc = d3.select("body").append("svg");

  moonText = d3.select("body").append("div").style("font-family", "sans-serif").style("font-size", "20px").style("color", "white").style("text-shadow", "1px 1px #111").style("text-align", "left").style("position", "absolute").style("display", "block").style("top", "10px").style("left", "5%");

  helpText = d3.select("body").append("div").style("font-family", "sans-serif").style("font-size", "20px").style("color", "white").style("text-shadow", "1px 1px #111").style("text-align", "right").style("position", "absolute").style("display", "block").style("top", "10px").style("right", "5%").html("s - zoom in<br>\na - zoom out<br>\nz - step backwards<br>\nZ - step backwards fast<br>\nx - step forwards<br>\nX - step forwards fast<br>\nArrow Keys - move<br>");

  timeText = d3.select("body").append("div").style("font-family", "sans-serif").style("font-size", "20px").style("color", "white").style("text-shadow", "1px 1px #111").style("text-align", "right").style("position", "absolute").style("display", "block").style("top", "80%").style("right", "5%").style("width", "100%").style("height", "100%").html("t: 0 days");

  init = function() {
    $(document).on('keydown', function(e) {
      if (e.key === "s") { // s = zoom in
        SCALE *= 0.95;
        redraw();
      }
      if (e.key === "a") { // a = zoom out
        SCALE /= 0.95;
        redraw();
      }
      if (e.key === "z") { // z = step backward
        current_time -= Config["DT"];
        if (current_time < Config["T0"]) {
          current_time = Config["T0"];
        }
        redraw();
      }
      if (e.key === "Z") { // Z = step backward fast
        current_time -= Config["DT"] * 10;
        if (current_time < Config["T0"]) {
          current_time = Config["T0"];
        }
        redraw();
      }
      if (e.key === "x") { // z = step forward
        current_time += Config["DT"];
        if (current_time > Config["T1"]) {
          current_time = Config["T1"];
        }
        redraw();
      }
      if (e.key === "X") { // Z = step forward fast
        current_time += Config["DT"] * 10;
        if (current_time > Config["T1"]) {
          current_time = Config["T1"];
        }
        redraw();
      }
      if (e.key === "ArrowLeft") { // Move
        GLOBALX += 5;
        redraw();
      }
      if (e.key === "ArrowRight") { // Move
        GLOBALX -= 5;
        redraw();
      }
      if (e.key === "ArrowUp") { // Move
        GLOBALY += 5;
        redraw();
      }
      if (e.key === "ArrowDown") { // Move
        GLOBALY -= 5;
        return redraw();
      }
    });
    svgDoc.append("div").text("Moon: ");
    return redraw();
  };

  redraw = function() {
    var paths, s;
    // Draw grid
    draw_grid(svgDoc);
    // Draw path
    // Remove all old paths
    svgDoc.selectAll("ellipse").remove();
    paths = svgDoc.selectAll("ellipse").data(moons);
    paths.enter().append("ellipse").attr("cx", function(m) {
      return `${-m.semimajor * m.ecc / SCALE * 50 + 50 + GLOBALX}%`;
    }).attr("cy", `${50 + GLOBALY}%`).attr("rx", function(m) {
      return `${m.semimajor / SCALE * 50}%`;
    }).attr("ry", function(m) {
      return `${m.semiminor / SCALE * 50}%`;
    });
    // Draw moons
    svgDoc.selectAll("circle").remove();
    s = svgDoc.selectAll("circle").data(moons);
    s.enter().append("circle").attr("cx", function(m) {
      return `${pos_to_percent(m.get_position_at_time(current_time)[0]) + GLOBALX}%`;
    }).attr("cy", function(m) {
      return `${pos_to_percent(m.get_position_at_time(current_time)[1]) + GLOBALY}%`;
    }).attr("r", function(m) {
      return 5;
    }).attr("fill", function(m) {
      return m.faction_color();
    }).attr("stroke", "black").on("mouseover", function(m) {
      var html;
      html = m.name;
      if (m.player !== null) {
        html += `<br>owned by ${m.player} (${m.faction})`;
      }
      moonText.html(html);
      return moonText.style("color", m.faction_color());
    });
    // Update time
    return timeText.html(`t: ${current_time.toFixed(2)} days`);
  };

  init();

}).call(this);

},{"./config.js":2,"./moon.js":3}],2:[function(require,module,exports){
// Generated by CoffeeScript 2.3.2
(function() {
  // Globals
  var DT, T0, T1;

  T0 = 0;

  T1 = 100;

  DT = 0.1;

  module.exports = {
    T0: T0,
    T1: T1,
    DT: DT
  };

}).call(this);

},{}],3:[function(require,module,exports){
// Generated by CoffeeScript 2.3.2
(function() {
  var Config, MOON_DATA, MoonClass, PI, TIME_CONSTANT, TIME_OFFSET, TWO_PI, parse_moons;

  Config = require("./config.js");

  TIME_CONSTANT = 6.378011090644188e-09;

  TIME_OFFSET = 27570;

  PI = 3.141592653589;

  TWO_PI = 2 * PI;

  MOON_DATA = "45,Taygete,Adam,Anarchy,10,0.016,5,22438648,0.3678,Carme,-1,\n18,not-Ananke,Kalen,AoE,10,0.00015,1,17739539,0.4449,Ananke (?),-1,\n33,Praxidike,Kalen,AoE,10,0.043,7,20823948,0.184,Ananke,-1,\n39,Ananke,Kalen,AoE,100,3,28,21454952,0.3445,Ananke,-1,\n78,Megaclite,Kalvin,Apples,10,0.021,5,24687239,0.3077,Pasiphae,-1,\n3,Amalthea,Kelly,BAIdu,100,208,175,181366,0.0075,Inner,1,\n4,Thebe,Croww,BAIdu,100,43,99,222452,0.018,Inner,1,\n5,Io,Jake,BAIdu,1000,8931900,3643,421700,0.0041,Galilean,1,\n9,Themisto,Croww,BAIdu,10,0.069,8,7393216,0.2115,Themisto,1,\n14,Lysithea,Gerry,BAIdu,10,6.3,36,11740560,0.1322,Himalia,1,\n24,Thelxinoe,Yariv,BAIdu,10,0.0015,2,20453753,0.2684,Ananke,-1,\n31,Iocaste,Kelly,BAIdu,10,0.019,5,20722566,0.2874,Ananke,-1,\n32,Melete,Anastasia,BAIdu,10,0.0015,2,20743779,0.3184,Ananke,-1,\n35,Mneme,Anastasia,BAIdu,10,0.0015,2,21129786,0.3169,Ananke,-1,\n36,Hermippe,Kelly,BAIdu,10,0.009,4,21182086,0.229,Ananke,-1,\n52,Aoede,Yariv,BAIdu,10,0.009,4,23044175,0.4311,Pasiphae,-1,\n71,Arche,Gerry,BAIdu,10,0.0045,3,23717051,0.1492,Carme,-1,\n44,Kale,NPC Bro,Blackatsuki,10,0.0015,2,22409207,0.2011,Carme,-1,\n0,Jupiter,NPCs,Contested,0,1.90E+11,1.40E+05,69911,0,Inner,1,\n8,Callisto,NPCs,Contested,1000,10759000,4821,1882709,0.0074,Galilean,1,\n11,Himalia,NPCs,Contested,100,670,170,11451971,0.1513,Himalia,1,\n34,Harpalyke,NPCs,Contested,10,0.012,4,21063814,0.244,Ananke,-1,\n41,Aitne,NPCs,Contested,10,0.0045,3,22285161,0.3927,Carme,-1,\n47,Chaldene,Roy,Contested,10,0.0075,4,22713444,0.2916,Carme,-1,\n51,Erinome,NPCs,Contested,10,0.0045,3,22986266,0.2552,Carme,-1,\n58,Callirrhoe,NPCs,Contested,10,0.087,9,23214986,0.2582,Pasiphae,-1,\n63,Kore,NPCs,Contested,10,0.0015,2,23345093,0.1951,Pasiphae,-1,\n69,Pasiphae,NPCs,Contested,100,30,60,23609042,0.3743,Pasiphae,-1,\n16,Dia,Turtle,CulTBD,10,0.009,4,12570424,0.2058,Himalia,1,\n40,Herse,Turtle,CulTBD,10,0.0015,2,22134306,0.2379,Carme,-1,\n12,Auge,Ryan,Daytime,10,0.0015,2,11453004,0.0944,Himalia,1,\n13,Arktos,Bryant,Daytime,10,0.0015,2,11494801,0.18,Himalia,1,\n21,Anatole,Ryan,Daytime,10,0.0015,2,19621780,0.2507,Ananke,-1,\n22,Mousike,Morning,Daytime,10,0.0015,2,20219648,0.1048,Ananke,-1,\n28,Gymnastike,Morning,Daytime,10,0.0015,2,20571458,0.2147,Ananke,-1,\n29,Nymphe,Luxury,Daytime,10,0.0015,3,20595483,0.1377,Ananke,-1,\n30,Mesembria,Afternoon,Daytime,10,0.0015,2,20639315,0.1477,Ananke,-1,\n38,Elete,Evening,Daytime,10,0.0015,2,21429955,0.2288,Ananke,-1,\n46,Akte,Bryant,Daytime,10,0.0015,2,22696750,0.2572,Carme,-1,\n68,Hesperis,Evening,Daytime,10,0.0015,2,23570790,0.3003,Pasiphae,-1,\n76,Sponde,Afternoon,Daytime,10,0.0015,2,24252627,0.4431,Pasiphae,-1,\n79,Dysis,Kalvin,Daytime,10,0.0015,2,28570410,0.4074,Pasiphae (?),-1,\n2,Adrastea,Genie NPC,God™,100,0.2,17,129000,0.0063,Inner,1,\n7,Ganymede,Brian,God™,1000,14819000,5262,1070412,0.0011,Galilean,1,Daddy\n15,Elara,Sophia,God™,10,87,86,11778034,0.1948,Himalia,1,\n19,Valetudo,Eli,God™,10,0.0015,1,18928095,0.2219,Valetudo,1,\n42,Auxo,Allen,God™,10,0.0015,2,22394682,0.5569,Pasiphae (fringe),-1,\n48,Thallo,Jared,God™,10,0.0015,2,22720999,0.0932,Pasiphae,-1,\n50,Xarpo,Jared,God™,10,0.0015,2,22739654,0.393,Pasiphae,-1,\n56,Kalyke,Kyle,God™,10,0.019,5,23180773,0.2139,Carme,-1,\n57,Carme,Michael,God™,100,13,46,23197992,0.2342,Carme,-1,\n59,Eurydome,Michael,God™,10,0.0045,3,23230858,0.3769,Pasiphae,-1,\n64,Cyllene,NPC God,God™,10,0.0015,2,23396269,0.4115,Pasiphae,-1,\n70,Hegemone,Kyle,God™,10,0.0045,3,23702511,0.4077,Pasiphae,-1,\n37,Thyone,MBD,MBD,10,0.009,4,21405570,0.2525,Ananke,-1,\n77,Autonoe,NPC Yanny,Mrs. Yanny,10,0.009,4,24264445,0.369,Pasiphae,-1,\n43,Calliope,Szilard,Muses,10,0.0015,1,22401817,0.2328,Carme,-1,\n54,Clio,Szilard,Muses,10,0.0015,2,23169389,0.2842,Carme,-1,\n55,Euterpe,Szilard,Muses,10,0.0015,1,23174446,0.3118,Carme,-1,\n60,Thalia,Good,Muses,10,0.0015,2,23240957,0.236,Carme,-1,\n62,Melpomene,Good,Muses,10,0.0015,2,23314335,0.32,Carme,-1,\n65,Terpsichore,Evil,Muses,10,0.0015,1,23400981,0.3321,Pasiphae,-1,\n66,Eukelade,Good,Muses,10,0.009,4,23483694,0.2828,Carme,-1,\n67,Erato,Evil,Muses,10,0.0015,2,23483978,0.3969,Pasiphae,-1,\n73,Polyhymnia,Evil,Muses,10,0.00015,1,23857808,0.2761,Carme,-1,\n74,Urania,Szilard,Muses,10,0.009,4,23973926,0.307,Carme,-1,\n1,Metis,Jamie,NATO Inc.,100,3.6,45,128852,0.0077,Inner,1,\n6,Europa,Mac,NATO Inc.,1000,4800000,3122,671034,0.0094,Galilean,1,\n10,Leda,Cheryl,NATO Inc.,10,0.6,16,11187781,0.1673,Himalia,1,\n17,Carpo,Cheryl,NATO Inc.,10,0.0045,3,17144873,0.2735,Carpo,1,\n20,Euporie,Joyce,NATO Inc.,10,0.0015,2,19088434,0.096,Ananke,-1,\n23,Pherousa,Darwin,NATO Inc.,10,0.0015,1,20307150,0.307,Ananke,-1,\n25,Euanthe,Mitch,NATO Inc.,10,0.0045,3,20464854,0.2,Ananke,-1,\n27,Orthosie,Mayia,NATO Inc.,10,0.0015,2,20567971,0.2433,Ananke,-1,\n49,not-Carme,NPC NATO,NATO Inc.,10,0.0015,2,22730813,0.3438,Carme,-1,\n53,Kallichore,Caug,NATO Inc.,10,0.0015,2,23111823,0.2041,Carme,-1,\n61,Pasithee,NPC NATO,NATO Inc.,10,0.0015,2,23307318,0.3288,Carme,-1,\n75,Sinope,Caug,NATO Inc.,100,7.5,38,24057865,0.275,Pasiphae,-1,\n26,Helike,Anthony,Penguins,10,0.009,4,20540266,0.1374,Ananke,-1,\n72,Isonoe,Eraser,SMS,10,0.0075,4,23800647,0.1775,Carme,-1,";

  MoonClass = class MoonClass {
    constructor(id, name1, player1, faction1, income1, mass1, diameter1, semimajor1, ecc1, sign1) {
      this.calculate_trajectory = this.calculate_trajectory.bind(this);
      this.id = id;
      this.name = name1;
      this.player = player1;
      this.faction = faction1;
      this.income = income1;
      this.mass = mass1;
      this.diameter = diameter1;
      this.semimajor = semimajor1;
      this.ecc = ecc1;
      this.sign = sign1;
      // Derived from
      // https://www.wikiwand.com/en/Kepler%27s_laws_of_planetary_motion
      this.period = TIME_CONSTANT * this.semimajor ** 1.5;
      this.semiminor = this.semimajor * Math.sqrt(1 - this.ecc ** 2);
      this.positions = this.calculate_trajectory();
    }

    get_position_at_time(t) {
      " Return the position of the moon at time t ";
      var i, i0, i1, p0, p0x, p0y, p1, p1x, p1y, px, py, s;
      // Convert time to index
      i = (t - Config["T0"]) / Config["DT"];
      // Interpolate between the indices we have
      i0 = Math.floor(i);
      i1 = Math.ceil(i);
      if (i0 >= this.positions.length) {
        i0 = this.positions.length - 1;
      }
      if (i1 >= this.positions.length) {
        i1 = this.positions.length - 1;
      }
      s = i - i0;
      p0 = this.positions[i0];
      p0x = p0[0];
      p0y = p0[1];
      p1 = this.positions[i1];
      p1x = p1[0];
      p1y = p1[1];
      px = p1x * s + p0x * (1 - s);
      py = p1y * s + p0y * (1 - s);
      return [px, py];
    }

    calculate_position_at_time(t) {
      " Return the position of the moon at time t ";
      var E, ITER_MAX, M, f, i, j, n, newton_step, r, ref, theta, x, x_new, y;
      t += TIME_OFFSET; // Compensate for start time
      n = TWO_PI / this.period; // mean motion
      M = n * t; // mean anomaly
      f = (x) => {
        return x - this.ecc * Math.sin(x) - M;
      };
      newton_step = (x) => {
        return (x - this.ecc * Math.sin(x) - M) / (2 * (1 - this.ecc * Math.cos(x)));
      };
      E = 0;
      x = M;
      ITER_MAX = 10;
      for (i = j = 0, ref = ITER_MAX; (0 <= ref ? j < ref : j > ref); i = 0 <= ref ? ++j : --j) {
        x_new = x - newton_step(x);
        E = x_new;
        if (f(x) < 0.001) { // desired accuracy achieved
          break;
        }
        x = x_new;
        if (i === ITER_MAX - 1) {
          console.log("Hit max iterations -- orbit may be slightly off course");
        }
      }
      theta = 2 * Math.atan(Math.sqrt(((1 + this.ecc) / (1 - this.ecc)) * Math.tan(E / 2) ** 2));
      if (E % TWO_PI > PI) {
        theta = TWO_PI - theta;
      }
      r = this.semimajor * (1 - this.ecc * Math.cos(E));
      theta *= this.sign; // Compensate for direction
      x = r * Math.cos(theta);
      y = r * Math.sin(theta);
      return [x, y];
    }

    calculate_trajectory() {
      var pos, poss, t;
      poss = [];
      t = Config["T0"];
      while (t <= Config["T1"]) {
        pos = this.calculate_position_at_time(t);
        poss.push(pos);
        t += Config["DT"];
      }
      return poss;
    }

    faction_color() {
      var d;
      d = {
        "BAIdu": "red",
        "NATO Inc.": "blue",
        "God™": "green",
        "Daytime": "yellow",
        "Contested": "orange",
        "Muses": "brown"
      };
      console.log(d[this.faction]);
      if (d[this.faction] != null) {
        return d[this.faction];
      } else {
        return "lightgray";
      }
    }

  };

  parse_moons = function() {
    var moons, parse_moon, row, rows;
    parse_moon = function(row) {
      var diameter, ecc, faction, id_, income, items, mass, moon, name, player, semimajor, sign;
      items = row.split(",");
      id_ = parseInt(items[0], 10);
      name = items[1];
      player = items[2];
      faction = items[3];
      income = parseInt(items[4], 10);
      mass = parseFloat(items[5]);
      diameter = parseFloat(items[6]);
      semimajor = parseFloat(items[7]);
      ecc = parseFloat(items[8]);
      sign = parseInt(items[10], 10);
      moon = new MoonClass(id_, name, player, faction, income, mass, diameter, semimajor, ecc, sign);
      return moon;
    };
    rows = MOON_DATA.split("\n");
    moons = (function() {
      var j, len, results;
      results = [];
      for (j = 0, len = rows.length; j < len; j++) {
        row = rows[j];
        results.push(parse_moon(row));
      }
      return results;
    })();
    return moons;
  };

  module.exports = {
    parse_moons: parse_moons
  };

}).call(this);

},{"./config.js":2}]},{},[1]);
